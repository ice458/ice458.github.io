<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Consent Mode default (runs before GTM) -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('consent', 'default', {
            ad_storage: 'denied',
            analytics_storage: 'denied',
            ad_user_data: 'denied',
            ad_personalization: 'denied',
            wait_for_update: 2000
        });
    </script>
    <!-- Google Analytics cookie domain override (host-only) -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('set', 'cookie_domain', 'none');
    </script>
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-MMZ5XH4V');</script>
    <!-- End Google Tag Manager -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RP2040/RP2350 PIO Simulator</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MMZ5XH4V" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
        <header>
            <h1>RP2040/RP2350 PIO Simulator</h1>
            <div class="dev-note" style="font-size: 0.9em; color: #777; margin-top: 4px;">このツールは現在開発中です。予告なく仕様が変更されます。</div>
        </header>

        <div class="main-content">
            <div class="editor-section">
                <h2>Assembly Code</h2>
                <div style="margin-bottom: 10px;">
                    <label>Load Example:</label>
                    <select id="example-select">
                        <option value="">-- Select Example --</option>
                        <option value="blink">Simple Blink</option>
                        <option value="pwm">PWM (LED Fade)</option>
                        <option value="feature_test">Feature Test (Wait/Jmp Pin)</option>
                    </select>
                </div>
                <textarea id="code-editor" spellcheck="false">
.program blink

.wrap_target
    set pins, 1   ; Turn on
    set pins, 0   ; Turn off
.wrap
                </textarea>
                <div class="controls">
                    <button id="btn-assemble">Assemble & Reset</button>
                    <button id="btn-step">Step</button>
                    <button id="btn-run-stop">Run</button>
                    <button id="btn-reset">Reset</button>
                </div>
                <div id="error-message" class="error"></div>

                <div id="program-display" class="program-display"></div>

                <h3>Pin Configuration</h3>
                <div class="control-panel pin-config">
                    <div class="config-item">
                        <label>OUT Base:</label>
                        <input type="number" id="cfg-out-base" value="0" min="0" max="31">
                    </div>
                    <div class="config-item">
                        <label>SET Base:</label>
                        <input type="number" id="cfg-set-base" value="0" min="0" max="31">
                    </div>
                    <div class="config-item">
                        <label>SET Count:</label>
                        <input type="number" id="cfg-set-count" value="5" min="1" max="5" title="Number of pins driven by SET (1-5)">
                    </div>
                    <div class="config-item">
                        <label>SIDESET Base:</label>
                        <input type="number" id="cfg-sideset-base" value="0" min="0" max="31">
                    </div>
                    <div class="config-item">
                        <label>IN Base:</label>
                        <input type="number" id="cfg-in-base" value="0" min="0" max="31">
                    </div>
                    <div class="config-item">
                        <label>JMP PIN:</label>
                        <input type="number" id="cfg-jmp-pin" value="0" min="0" max="31">
                    </div>
                </div>
                <h3>Timing Chart Pins</h3>
                <div class="control-panel">
                    <div style="font-size: 0.8em; color: #666; margin-bottom: 5px;">Select pins to display in timing chart.</div>
                    <div class="gpio-indicators" id="timing-pin-selector"></div>
                </div>
                <h3>Shift & FIFO Control</h3>
                <div class="control-panel pin-config">
                    <div class="config-item">
                        <label>IN Shift:</label>
                        <select id="cfg-in-shift-dir">
                            <option value="right">Right (MSB)</option>
                            <option value="left">Left (LSB)</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>OUT Shift:</label>
                        <select id="cfg-out-shift-dir">
                            <option value="right">Right (LSB)</option>
                            <option value="left">Left (MSB)</option>
                        </select>
                    </div>
                    <div style="width: 100%"></div>
                    <div class="config-item" style="margin-right: 20px;">
                        <label>Auto Push:</label>
                        <input type="checkbox" id="cfg-auto-push">
                        <input type="number" id="cfg-push-thresh" value="32" min="1" max="32" style="width: 40px;">
                    </div>
                    <div class="config-item">
                        <label>Auto Pull:</label>
                        <input type="checkbox" id="cfg-auto-pull">
                        <input type="number" id="cfg-pull-thresh" value="32" min="1" max="32" style="width: 40px;">
                    </div>
                </div>
            </div>

            <div class="status-section">
                <h2>State <span id="status-indicator"
                        style="font-size: 0.6em; padding: 2px 5px; border-radius: 3px;">STOPPED</span></h2>
                <div class="registers">
                    <div class="reg">PC: <span id="reg-pc">0</span></div>
                    <div class="reg">Clock: <span id="reg-clock">0</span></div>
                    <div class="reg">X: <span id="reg-x">0x00000000</span></div>
                    <div class="reg">Y: <span id="reg-y">0x00000000</span></div>
                    <div class="reg">OSR: <span id="reg-osr">0x00000000</span> (<span id="reg-osr-count">0</span>)</div>
                    <div class="reg">ISR: <span id="reg-isr">0x00000000</span> (<span id="reg-isr-count">0</span>)</div>
                </div>

                <h3>FIFOs</h3>
                <div class="fifos">
                    <div class="fifo-box">
                        <h4>TX FIFO</h4>
                        <input type="text" id="tx-input" placeholder="Hex value (e.g. 0xFF)">
                        <button id="btn-push-tx">Push</button>
                        <ul id="tx-fifo-list"></ul>
                    </div>
                    <div class="fifo-box">
                        <h4>RX FIFO</h4>
                        <ul id="rx-fifo-list"></ul>
                    </div>
                </div>

                <div class="pin-output">
                    <h4>GPIO State (32-bit)</h4>
                    <div class="hex-display">Value: <span id="gpio-hex-val">0x00000000</span></div>
                    <div style="font-size: 0.8em; color: #666; margin-bottom: 5px;">
                        Click: Toggle Input Value.<br>Right-Click/Shift+Click: Toggle Direction (In/Out).
                        <br>
                        <span style="border: 1px solid #4caf50; background: #4caf50; width: 10px; height: 10px; display: inline-block;"></span> Output High
                        <span style="border: 1px solid #ccc; background: #eee; width: 10px; height: 10px; display: inline-block;"></span> Output Low
                        <span style="border: 1px dashed #2196f3; background: #e3f2fd; width: 10px; height: 10px; display: inline-block;"></span> Input Low
                        <span style="border: 1px dashed #2196f3; background: #2196f3; width: 10px; height: 10px; display: inline-block;"></span> Input High
                    </div>
                    <div class="gpio-indicators" id="gpio-indicators"> </div>
                </div>

                <h3 id="timing-chart-title">Timing Chart (GPIO 0-3)</h3>
                <canvas id="timing-chart" width="600" height="200"></canvas>

                <h3>Interrupts (IRQ)</h3>
                <div style="font-size: 0.8em; color: #666; margin-bottom: 5px;">
                    Click to toggle IRQ flag.
                </div>
                <div class="irq-controls">
                    <div class="irq-flags" id="irq-flags">
                        <!-- IRQ 0-7 flags -->
                    </div>
                </div>
            </div>
        </div>

        <footer
            style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ccc; text-align: center; font-size: 0.9em;">
            <p>
                <a href="../../index.html">ice458の物置き</a> |
                <a href="../../tools.html">Webツール一覧</a> |
                <a href="../../privacy.html">プライバシーポリシー</a>
            </p>
        </footer>
    </div>

    <script src="pio_assembler.js"></script>
    <script src="pio_emulator.js"></script>
    <script src="main.js"></script>
    <script src="/consent.js" defer></script>
</body>

</html>